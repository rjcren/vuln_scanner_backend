"""漏洞模型"""
from datetime import datetime
from sqlalchemy import inspect
from app.extensions import db

class Vulnerability(db.Model):
    __tablename__ = "vulnerabilities"
    vul_id = db.Column(db.Integer, primary_key=True)
    task_id = db.Column(db.Integer, db.ForeignKey("scan_tasks.task_id", ondelete="CASCADE"), nullable=False)
    scan_source = db.Column(db.String(10), nullable=False, comment="扫描出漏洞的扫描工具")
    scan_id = db.Column(db.String(40), unique=True, comment="在对应扫描工具中的id")
    vul_type = db.Column(db.String(255))
    severity = db.Column(db.Enum("critical", "high", "medium", "low", "info"), default="info", nullable=False)
    details = db.Column(db.Text, comment="攻击详情")
    description = db.Column(db.Text, comment="漏洞描述")
    solution = db.Column(db.Text, comment="修复建议")
    time = db.Column(db.DateTime, default=datetime.now, nullable=False)

    task = db.relationship("ScanTask", back_populates="vulnerabilities")

    def to_dict(self):
        return {c.key: getattr(self, c.key) for c in inspect(self).mapper.column_attrs}